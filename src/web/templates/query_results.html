<div class="results-header">
    <div class="results-summary">
        <h3>Results for "{{ query }}"</h3>
        <div class="stats">
            <span class="stat">
                <strong>{{ total_matches }}</strong> matches
            </span>
            <span class="stat">
                <strong>{{ "{:,}".format(total_tokens) }}</strong> tokens
            </span>
            <span class="stat">
                Threshold: <strong>{{ (threshold * 100)|round(0)|int }}%</strong>
            </span>
        </div>
    </div>
</div>

{% if total_matches == 0 %}
<div class="no-results">
    <h4>No matches found</h4>
    <p>Try:</p>
    <ul>
        <li>Lowering the similarity threshold</li>
        <li>Using different keywords</li>
        <li>Being more general in your query</li>
    </ul>
</div>
{% else %}

<div class="results-list" x-data="{ expandedItems: {} }">
    {% for match in matches %}
    <div class="result-item" x-data="{ id: '{{ loop.index }}' }">
        <div class="result-header" @click="expandedItems[id] = !expandedItems[id]">
            <div class="result-title">
                <span class="check-icon">âœ“</span>
                <strong>{{ match.data_key }}</strong>
                {% if match.description %}
                <p class="result-description">{{ match.description }}</p>
                {% endif %}
            </div>
            <div class="result-meta">
                <span class="similarity-score" :class="{ 'high': {{ match.similarity }} >= 0.8, 'medium': {{ match.similarity }} >= 0.6 }">
                    Score: {{ match.similarity_percent }}%
                </span>
                {% if match.toon_tokens %}
                <span class="token-count">{{ "{:,}".format(match.toon_tokens) }} tokens</span>
                {% endif %}
                {% if match.savings_percent > 0 %}
                <span class="token-savings">-{{ match.savings_percent }}% vs JSON</span>
                {% endif %}
                <span class="expand-icon" x-text="expandedItems[id] ? 'â–²' : 'â–¼'">â–¼</span>
            </div>
        </div>

        <div class="result-preview" x-show="!expandedItems[id]">
            <pre class="scrollable-preview"><code>{{ match.data_toon }}</code></pre>
        </div>

        <div class="result-content" x-show="expandedItems[id]" x-cloak x-data="{
            viewMode: 'toon',
            toonData: {{ match.data_toon|tojson }},
            jsonData: {{ match.data_json|tojson }}
        }">
            <div class="content-header">
                <div class="view-toggle">
                    <button
                        class="btn-small"
                        :class="{ 'active': viewMode === 'toon' }"
                        @click="viewMode = 'toon'"
                    >
                        ðŸŽ¯ TOON <span class="token-badge">{{ match.toon_tokens }}</span>
                    </button>
                    <button
                        class="btn-small"
                        :class="{ 'active': viewMode === 'json' }"
                        @click="viewMode = 'json'"
                    >
                        JSON <span class="token-badge">{{ match.json_tokens }}</span>
                    </button>
                </div>
                <button
                    class="btn-small"
                    @click.stop="navigator.clipboard.writeText(viewMode === 'toon' ? toonData : jsonData).then(() => {
                        $event.target.textContent = 'âœ“ Copied!';
                        setTimeout(() => $event.target.textContent = 'Copy', 2000);
                    })"
                >
                    Copy
                </button>
            </div>

            <!-- Token Savings Banner -->
            {% if match.savings_percent > 0 %}
            <div class="token-savings-banner">
                ðŸ’° <strong>{{ match.token_savings }} tokens saved</strong> ({{ match.savings_percent }}% reduction) with TOON format
            </div>
            {% endif %}

            <!-- TOON View -->
            <div x-show="viewMode === 'toon'" class="scrollable-content">
                <pre><code class="toon">{{ match.data_toon }}</code></pre>
            </div>

            <!-- JSON View -->
            <div x-show="viewMode === 'json'" class="scrollable-content">
                <pre><code class="json">{{ match.data_json }}</code></pre>
            </div>

            <div class="result-actions">
                <button class="btn-small" @click="window.open('/api/projects/{{ project_id }}/query', '_blank')">
                    Query API
                </button>
                <button class="btn-small" @click="alert('Agent integration coming soon!')">
                    Add to Agent Context
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="results-footer">
    <p class="context-info">
        ðŸ’¡ <strong>Context Window Check:</strong>
        {% if total_tokens < 8000 %}
        All results fit in GPT-4 Turbo (8k context)
        {% elif total_tokens < 32000 %}
        All results fit in GPT-4 (32k context)
        {% elif total_tokens < 128000 %}
        All results fit in GPT-4 Turbo (128k context)
        {% else %}
        Results exceed most context windows - consider filtering
        {% endif %}
    </p>

    <div class="export-actions" x-data="{
        exportData: {{ matches|tojson }},
        toonExport: `{% for match in matches %}{{ match.data_key }}:\n{{ match.data_toon }}\n\n{% endfor %}`
    }">
        <button
            class="btn-secondary"
            @click="navigator.clipboard.writeText(toonExport).then(() => {
                $event.target.innerHTML = 'âœ“ Copied!';
                setTimeout(() => $event.target.innerHTML = 'ðŸ“‹ Export All as TOON', 2000);
            })"
        >
            ðŸ“‹ Export All as TOON
        </button>
        <button
            class="btn-secondary"
            @click="navigator.clipboard.writeText(JSON.stringify(exportData, null, 2)).then(() => {
                $event.target.innerHTML = 'âœ“ Copied!';
                setTimeout(() => $event.target.innerHTML = 'ðŸ“‹ Export All as JSON', 2000);
            })"
        >
            ðŸ“‹ Export All as JSON
        </button>
    </div>
</div>

{% endif %}

<style>
[x-cloak] { display: none !important; }
</style>
